<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Marina Caju — Veículos</title>

<link rel="stylesheet" href="../assets/style.css">

<style>
  /* Cabeçalho padrão */
  header .brand img#logo{height:40px;width:auto;display:block;}
  #menuBtn{text-decoration:none !important;}

  main{max-width:1100px;margin:20px auto;}
  .card{background:var(--surface);border-radius:14px;box-shadow:var(--card-shadow);padding:20px;}

  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
  .grid .full{grid-column:1/4;}

  label{font-weight:500;color:var(--muted);}
  input,select{
    width:100%;padding:10px;border:1px solid var(--line);
    border-radius:8px;background:#fff;font-size:15px;
  }

  .footer-actions{display:flex;gap:10px;margin-top:10px}
  .btn.brand{background:var(--brand);color:#fff;border:none;border-radius:8px;padding:10px 16px;cursor:pointer;}
  .btn.ghost{background:transparent;border:1px solid var(--line);border-radius:8px;padding:10px 16px;cursor:pointer;}
  .btn.danger{background:var(--danger);color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;}

  .badge{display:inline-block;background:#f3f4f6;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:13px}
  .row{display:flex;align-items:center;gap:10px}

  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:12px;border-bottom:1px solid var(--line);text-align:left;font-size:15px}
  th{background:#f3f4f6;font-weight:600}

  @media(max-width:900px){
    .grid{grid-template-columns:1fr 1fr}
    .grid .full{grid-column:1/3}
  }
  @media(max-width:620px){
    .grid{grid-template-columns:1fr}
    .grid .full{grid-column:1}
  }
</style>
</head>

<body>

<header>
  <div class="brand">
    <img id="logo" alt="Logo" src="../assets/logo.png">
    <div>
      <div class="title">Marina Caju — Sistema Interno</div>
      <div class="small">Veículos</div>
    </div>
  </div>

  <div class="right">
    <a class="btn brand" id="menuBtn" href="../index.html">Menu</a>
  </div>
</header>

<main>

  <!-- CADASTRO -->
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="badge">Cadastro de veículo</div>
      <div class="small"></div>
    </div>

    <div class="grid" style="margin-top:12px">
      <!-- 1ª linha: Tipo / Pés / Pontoon -->
      <div>
        <label>Tipo</label>
        <select id="v_tipo" required>
          <option value="" disabled selected>Selecione...</option>
          <option value="Lancha">Lancha</option>
          <option value="Jet">Jet</option>
          <option value="Canoa">Canoa</option>
          <option value="VCat">VCat</option><!-- novo -->
        </select>
      </div>

      <div id="grp_pes">
        <label>Pés (apenas Lancha)</label>
        <input id="v_pes" type="number" step="1" min="0" placeholder="— apenas para Lancha —">
      </div>

      <div>
        <label>Pontoon (+R$5/pé)</label>
        <select id="v_pontoon">
          <option value="nao">Não</option>
          <option value="sim">Sim</option>
        </select>
      </div>

      <!-- 2ª linha: Cliente principal / Co-pagante -->
      <div>
        <label>Cliente principal</label>
        <select id="v_cliente" required>
          <option value="" disabled selected>Selecione...</option>
        </select>
      </div>

      <div>
        <label>Co-pagante</label>
        <select id="v_copagante">
          <option value="">Nenhum</option>
        </select>
      </div>

      <!-- Demais campos -->
      <div class="full">
        <label>Identificação / Registro</label>
        <input id="v_reg" placeholder="Série / Nome / Registro">
      </div>

      <div class="full">
        <label>Observações</label>
        <input id="v_obs" placeholder="Notas internas">
      </div>
    </div>

    <div class="footer-actions">
      <button class="btn brand" id="v_salvar">Salvar</button>
      <button class="btn ghost" id="v_limpar">Limpar</button>
    </div>
  </div>

  <!-- LISTA -->
  <div class="card" style="margin-top:14px">
    <div class="row">
      <div class="badge">Veículos cadastrados</div>
    </div>

    <table class="table" id="tbl">
      <thead>
        <tr>
          <th>Tipo</th>
          <th>Pés</th>
          <th>Pontoon</th>
          <th>Cliente</th>
          <th>Co-pagante</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

  </div>

</main>

<script>
/* Storage */
const K_CLI='mc_clientes';
const K_VEI='mc_veiculos';

function load(k,def){ try{const v=JSON.parse(localStorage.getItem(k));return v??def;}catch{return def;} }
function save(k,v){ localStorage.setItem(k,JSON.stringify(v)); }
function uuid(){ return crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2); }

/* Carregar clientes em Cliente e Co-pagante */
function fillClientes(){
  const clientes=load(K_CLI,[]);
  const cli=document.getElementById('v_cliente');
  const co=document.getElementById('v_copagante');

  // Mantém placeholder "Selecione..."
  cli.innerHTML = `<option value="" disabled selected>Selecione...</option>` +
                  clientes.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('');

  // Co-pagante com "Nenhum" como default
  co.innerHTML = `<option value="">Nenhum</option>` +
                  clientes.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('');

  // Evita co-pagante igual ao principal
  cli.onchange=()=>{
    const principal=cli.value;
    [...co.options].forEach(o=>{
      o.disabled = (o.value && o.value===principal);
      if(o.disabled) o.selected=false;
    });
  };
  cli.dispatchEvent(new Event("change"));
}

/* Pés sempre visível; só habilita quando Tipo = Lancha */
function togglePes(){
  const t = document.getElementById('v_tipo').value;
  const grp = document.getElementById('grp_pes');
  const pesInput = document.getElementById('v_pes');

  grp.style.display = 'block';               // sempre visível
  const isLancha = (t === 'Lancha');
  pesInput.disabled = !isLancha;             // edita só em Lancha
  pesInput.placeholder = isLancha ? '' : '— apenas para Lancha —';
  if(!isLancha){ pesInput.value = ''; }      // limpa se não for Lancha
}

/* Renderizar tabela */
function render(){
  const tbody=document.querySelector('#tbl tbody');
  tbody.innerHTML='';

  const clientesMap=Object.fromEntries(load(K_CLI,[]).map(c=>[c.id,c.nome]));
  const lista=load(K_VEI,[]);

  lista.forEach(v=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${v.tipo}</td>
      <td>${v.tipo==='Lancha' ? (v.pes ?? '-') : '-'}</td>
      <td>${v.pontoon?'Sim':'Não'}</td>
      <td>${clientesMap[v.clienteId]||''}</td>
      <td>${clientesMap[v.copaganteId]||'-'}</td>
      <td>
        <button class="btn ghost" data-edit="${v.id}">Editar</button>
        <button class="btn danger" data-del="${v.id}">Excluir</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* Limpar formulário */
function limpar(){
  document.getElementById('v_tipo').value='';         // volta para "Selecione..."
  document.getElementById('v_pes').value='';
  document.getElementById('v_pontoon').value='nao';
  document.getElementById('v_cliente').value='';      // volta para "Selecione..."
  document.getElementById('v_copagante').value='';    // "Nenhum"
  document.getElementById('v_reg').value='';
  document.getElementById('v_obs').value='';
  document.getElementById('v_salvar').removeAttribute('data-id');
  togglePes();
}

/* Salvar veículo */
document.getElementById('v_salvar').onclick=()=>{

  const tipo=document.getElementById('v_tipo').value;
  const pes = tipo==='Lancha' ? (+document.getElementById('v_pes').value||null) : null;
  const pontoon=document.getElementById('v_pontoon').value==='sim';
  const clienteId=document.getElementById('v_cliente').value;
  const copaganteId=document.getElementById('v_copagante').value || '';
  const registro=document.getElementById('v_reg').value.trim();
  const obs=document.getElementById('v_obs').value.trim();

  // Validações
  if(!tipo){ alert('Selecione o tipo do veículo.'); return; }
  if(!clienteId){ alert('Selecione o cliente principal.'); return; }

  const id = document.getElementById('v_salvar').dataset.id || uuid();

  const novo={ id, tipo, pes, pontoon, clienteId, copaganteId, registro, obs };

  const lista=load(K_VEI,[]);
  const ix=lista.findIndex(x=>x.id===id);
  if(ix>=0) lista[ix]=novo;
  else lista.push(novo);

  save(K_VEI,lista);
  limpar();
  render();
  alert("Veículo salvo.");
};

/* Editar / Excluir */
document.addEventListener('click',e=>{
  if(e.target.dataset.edit){
    const id=e.target.dataset.edit;
    const v=load(K_VEI,[]).find(x=>x.id===id);
    if(!v) return;

    document.getElementById('v_tipo').value=v.tipo || '';
    togglePes();
    document.getElementById('v_pes').value=v.pes ?? '';
    document.getElementById('v_pontoon').value=v.pontoon?'sim':'nao';

    // Seleções com fallback para placeholder
    document.getElementById('v_cliente').value=v.clienteId || '';
    document.getElementById('v_cliente').dispatchEvent(new Event("change"));
    document.getElementById('v_copagante').value=v.copaganteId || '';

    document.getElementById('v_reg').value=v.registro || '';
    document.getElementById('v_obs').value=v.obs || '';

    document.getElementById('v_salvar').dataset.id=id;
    window.scrollTo({top:0,behavior:'smooth'});
  }

  if(e.target.dataset.del){
    const id=e.target.dataset.del;
    if(!confirm('Excluir veículo?')) return;
    const lista=load(K_VEI,[]).filter(x=>x.id!==id);
    save(K_VEI,lista);
    render();
  }
});

/* Listeners */
document.getElementById('v_tipo').addEventListener('change', togglePes);
document.getElementById('v_limpar').addEventListener('click', limpar);

/* Init */
(function(){
  fillClientes();
  limpar();   // começa com placeholders e já aplica togglePes()
  render();
})();
</script>

</body>
</html>
